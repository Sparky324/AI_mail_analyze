<!-- letter_list.html - проверяем циклы -->
{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Все письма</h1>
    <a href="{% url 'upload_letter' %}" class="btn btn-primary">+ Добавить письмо</a>
</div>

<!-- Фильтры -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Фильтры</h5>
        <form method="get" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Статус:</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">Все статусы</option>
                    {% for status_value, status_name in status_choices %}
                        <option value="{{ status_value }}"
                            {% if request.GET.status == status_value %}selected{% endif %}>
                            {{ status_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Классификация:</label>
                <select name="classification" class="form-select" onchange="this.form.submit()">
                    <option value="">Все типы</option>
                    {% for class_value, class_name in classification_choices %}
                        <option value="{{ class_value }}"
                            {% if request.GET.classification == class_value|stringformat:"i" %}selected{% endif %}>
                            {{ class_name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <a href="{% url 'letter_list' %}" class="btn btn-outline-secondary mt-4">Сбросить фильтры</a>
            </div>
        </form>

        <!-- Покажем активные фильтры -->
        {% if request.GET.status or request.GET.classification %}
        <div class="mt-3">
            <small class="text-muted">Активные фильтры:</small>
            {% if request.GET.status %}
                {% for status_value, status_name in status_choices %}
                    {% if status_value == request.GET.status %}
                        <span class="badge bg-primary me-1">
                            Статус: {{ status_name }}
                            <a href="?{% if request.GET.classification %}classification={{ request.GET.classification }}{% endif %}"
                               class="text-white ms-1 text-decoration-none">×</a>
                        </span>
                    {% endif %}
                {% endfor %}
            {% endif %}

            {% if request.GET.classification %}
                {% for class_value, class_name in classification_choices %}
                    {% if class_value|stringformat:"i" == request.GET.classification %}
                        <span class="badge bg-primary me-1">
                            Тип: {{ class_name }}
                            <a href="?{% if request.GET.status %}status={{ request.GET.status }}{% endif %}"
                               class="text-white ms-1 text-decoration-none">×</a>
                        </span>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Остальной код без изменений -->
{% if letters %}
    {% for letter in letters %}
        <div class="card letter-card status-{{ letter.status }} mb-3
            {% if letter.sla_deadline and letter.sla_deadline <= time_threshold and letter.status != 'done' and letter.status != 'archived' %}border-warning bg-light-warning{% endif %}">
            <div class="card-body">
                <!-- Предупреждение о срочности (только для незавершенных писем) -->
                {% if letter.sla_deadline and letter.sla_deadline <= time_threshold and letter.status != 'done' and letter.status != 'archived' %}
                <div class="alert alert-warning py-2 mb-3">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Срочно!</strong> Дедлайн истекает {{ letter.sla_deadline|date:"d.m.Y H:i" }}
                </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-8">
                        <h5 class="card-title">{{ letter.subject }}</h5>
                        <p class="card-text"><strong>Отправитель:</strong> {{ letter.sender }}</p>
                        {% if letter.summary %}
                            <p class="card-text"><strong>Краткое содержание:</strong> {{ letter.summary|truncatewords:20 }}</p>
                        {% endif %}
                        <p class="card-text">
                            <small class="text-muted">
                                Загружено: {{ letter.uploaded_at|date:"d.m.Y H:i" }}
                            </small>
                        </p>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex flex-column h-100">
                            <div class="mb-2">
                                <span class="badge bg-secondary">#{{ letter.id }}</span>
                                <span class="badge bg-{% if letter.status == 'new' %}secondary{% elif letter.status == 'analyzed' %}info{% elif letter.status == 'response_generated' %}warning{% else %}success{% endif %}">
                                    {{ letter.get_status_display }}
                                </span>
                                <!-- Бейдж "Срочно" только для незавершенных писем -->
                                {% if letter.sla_deadline and letter.sla_deadline <= time_threshold and letter.status != 'done' and letter.status != 'archived' %}
                                <span class="badge bg-danger">Срочно</span>
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <strong>Тип:</strong> {{ letter.get_classification_display|default:"Не определен" }}
                            </div>
                            <div class="mb-2">
                                <strong>Критичность:</strong>
                                <span class="badge bg-{% if letter.criticality_level == 1 %}success{% elif letter.criticality_level == 2 %}warning{% elif letter.criticality_level == 3 %}danger{% else %}dark{% endif %}">
                                    {{ letter.get_criticality_level_display|default:"Не определена" }}
                                </span>
                            </div>
                            <!-- Дедлайн показываем только для незавершенных писем -->
                            {% if letter.sla_deadline and letter.status != 'done' and letter.status != 'archived' %}
                            <div class="mb-2">
                                <strong>Дедлайн:</strong>
                                <small class="text-{% if letter.sla_deadline < now %}danger{% elif letter.sla_deadline <= time_threshold %}warning{% else %}success{% endif %}">
                                    {{ letter.sla_deadline|date:"d.m.Y H:i" }}
                                </small>
                            </div>
                            {% endif %}
                            <div class="mt-auto">
                                <a href="{% url 'letter_detail' letter.id %}" class="btn btn-sm btn-outline-primary">Подробнее</a>
                                {% if letter.status == 'new' %}
                                    <a href="{% url 'analyze_letter' letter.id %}" class="btn btn-sm btn-warning">Анализировать</a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-info">
        {% if request.GET.status or request.GET.classification %}
            Писем по выбранным фильтрам не найдено. <a href="{% url 'letter_list' %}">Показать все письма</a>.
        {% else %}
            Писем пока нет. <a href="{% url 'upload_letter' %}">Добавьте первое письмо</a>.
        {% endif %}
    </div>
{% endif %}
{% endblock %}